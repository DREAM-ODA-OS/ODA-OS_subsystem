/*
 * mwps - Mapshup Standalone WPS library
 * 
 * mwps is a standalone library extracted from the mapshup applicative framework
 * http://mapshup.info
 *
 * Copyright Jérôme Gasperi, 2013
 *
 * This software is a computer program whose purpose is a webmapping application
 * to display and manipulate geographical data.
 *
 * This software is governed by the CeCILL-B license under French law and
 * abiding by the rules of distribution of free software.  You can  use,
 * modify and/ or redistribute the software under the terms of the CeCILL-B
 * license as circulated by CEA, CNRS and INRIA at the following URL
 * "http://www.cecill.info".
 *
 * As a counterpart to the access to the source code and  rights to copy,
 * modify and redistribute granted by the license, users are provided only
 * with a limited warranty  and the software's author,  the holder of the
 * economic rights,  and the successive licensors  have only  limited
 * liability.
 *
 * In this respect, the user's attention is drawn to the risks associated
 * with loading,  using,  modifying and/or developing or reproducing the
 * software by the user in light of its specific status of free software,
 * that may mean  that it is complicated to manipulate,  and  that  also
 * therefore means  that it is reserved for developers  and  experienced
 * professionals having in-depth computer knowledge. Users are therefore
 * encouraged to load and test the software's suitability as regards their
 * requirements in conditions enabling the security of their systems and/or
 * data to be ensured and,  more generally, to use and operate it in the
 * same conditions as regards security.
 *
 * The fact that you are presently reading this means that you have had
 * knowledge of the CeCILL-B license and that you accept its terms.
 */
M={Util:{sequence:0,updateCB:function(){},cb_context:null,setUpdateCB:function(a){M.Util.updateCB=a},setCBContext:function(a){M.Util.cb_context=a},clone:function(a){if("object"!=typeof a||null==a)return a;var b,c=a.constructor();for(b in a)c[b]=M.Util.clone(a[b]);return c},extendUrl:function(a,b){var c,e,d,g,h,f={},i="",j=a.split("?")[0];try{h=a.split("?")[1].split("&")}catch(k){h=[]}d=0;for(g=h.length;d<g;d++)c=h[d].split("=")[0],e=h[d].split("=")[1],c&&e&&(f[c]=e);b=$.extend(b,f);for(c in b)i+=
c+"="+b[c]+"&";return j+"?"+i},stringToRealType:function(a){return!a?a:$.isNumeric(a)?parseFloat(a):"true"===a.toLowerCase()?!0:"false"===a.toLowerCase()?!1:a},getAttributes:function(a){var b,c,e={};if(a&&a.length){a=a[0].attributes;b=0;for(c=a.length;b<c;b++)e[M.Util.stripNS(a[b].nodeName)]=M.Util.stringToRealType(a[b].nodeValue)}return e},stripNS:function(a){if(!a)return null;a=a.split(":");return 2===a.length?a[1]:a[0]},stripTags:function(a){var b=document.createElement("DIV");b.innerHTML=a;return b.textContent||
b.innerText},message:function(a){console&&"function"===typeof console.log&&console.log(a);"function"===typeof M.Util.updateCB&&M.Util.updateCB(a,M.Util.cb_context)},isUrl:function(a){return a&&"string"===typeof a&&(a=a.substr(0,7),"http://"===a||"https:/"===a||"ftp://"===a)?!0:!1},proxify:function(a,b,c){if(c&&""!==c){var e=Math.round(865*Math.random()),d=Math.round(757*Math.random());return c+("&a="+e+"&b="+d+"&c="+(e+17-3*(d-2)))+(b?"&returntype="+b:"")+"&url="+encodeURIComponent(a)}return a},parseTemplate:function(a,
b,c){b=b||{};c=c||{};return"string"===typeof a?a.replace(/\$+([^\$])+\$/g,function(a){var d,a=a.replace(/[\$\$]/g,""),g=b[a];for(d in c)if(a===d){if($.isFunction(c[d].transform))return c[d].transform(g);break}return g?g:"$"+a+"$"}):a},repareUrl:function(a){if(!a)return null;var b=a.indexOf("?");return-1===b?a+"?":b===a.length-1||-1!==a.indexOf("&",a.length-1)?a:a+"&"},lowerFirstLetter:function(a){return a.charAt(0).toLowerCase()+a.slice(1)},getGeoType:function(a){if(!a)return null;var b=[];b["text/xml; subtype=gml/3.1.1"]=
"GML";b["application/gml+xml"]="GML";b["text/gml"]="GML";b["application/geo+json"]="JSON";b["application/geojson"]="JSON";b["application/wkt"]="WKT";b["application/x-ogc-wms"]="WMS";return b[a.toLowerCase()]}},WPS:function(a,b){this.events=new M.WPS.Events;this.url=a;this.proxyUrl=b;this.title=null;this["abstract"]=null;this.version="1.0.0";this.serviceProvider={};this.descriptors=[];this.init=function(a){this.url=a};this.getCapabilities=function(){var a,e=this;this.title?this.events.trigger("getcapabilities",
this):(a=M.Util.extendUrl(this.url,{service:"WPS",version:e.version,request:"GetCapabilities"}),$.ajax({url:M.Util.proxify(M.Util.repareUrl(a),"XML",this.proxyUrl),async:!0,dataType:"xml",success:function(a){e.parseCapabilities(a);e.events.trigger("getcapabilities",e)},error:function(){M.Util.message("Error reading Capabilities file")}}))};this.describeProcess=function(a){var e,b=this;$.isArray(a)||(a=[a]);if(1===a.length&&(e=this.getProcessDescriptor(a[0]))&&e.dataInputsDescription)return b.events.trigger("describeprocess",
[e]),!0;a=M.Util.extendUrl(b.url,{service:"WPS",version:b.version,request:"DescribeProcess",identifier:a.join(",")});$.ajax({url:M.Util.proxify(M.Util.repareUrl(a),"XML",this.proxyUrl),async:!0,dataType:"xml",success:function(a){var e,c,i=b.parseDescribeProcess(a),j=[],a=0;for(e=i.length;a<e;a++)c=new M.WPS.ProcessDescriptor(i[a]),b.addProcessDescriptor(c),j.push(c);b.events.trigger("describeprocess",j)},error:function(){M.Util.message("Error reading DescribeProcess file")}});return!0};this.parseCapabilities=
function(a){var b=this;$(a).find("*").filter(function(){if("ServiceIdentification"===M.Util.stripNS(this.nodeName))$(this).children().filter(function(){var a=M.Util.stripNS(this.nodeName);if("Title"===a||"Abstract"===a)b[M.Util.lowerFirstLetter(a)]=$(this).text()});else if("ServiceProvider"===M.Util.stripNS(this.nodeName)){var a={},c={},h={};b.serviceProvider={};$(this).children().filter(function(){switch(M.Util.stripNS(this.nodeName)){case "ServiceContact":$(this).children().each(function(){switch(M.Util.stripNS(this.nodeName)){case "ContactInfo":$(this).children().each(function(){switch(M.Util.stripNS(this.nodeName)){case "Phone":h=
b.parseLeaf($(this));break;case "Address":c=b.parseLeaf($(this))}});break;default:a[M.Util.lowerFirstLetter(M.Util.stripNS(this.nodeName))]=$(this).text()}});break;default:b.serviceProvider[M.Util.lowerFirstLetter(M.Util.stripNS(this.nodeName))]=$(this).text()}});b.serviceProvider.contact=a||{};b.serviceProvider.contact.phone=h;b.serviceProvider.contact.address=c}else"Process"===M.Util.stripNS(this.nodeName)&&b.addProcessDescriptor(new M.WPS.ProcessDescriptor(b.parseLeaf($(this))))});return!0};this.parseDescribeProcess=
function(a){var b=this,d=[];$(a).find("*").filter(function(){if("ProcessDescription"===M.Util.stripNS(this.nodeName)){var a,c={};$.extend(c,M.Util.getAttributes($(this)));$(this).children().filter(function(){a=M.Util.lowerFirstLetter(M.Util.stripNS(this.nodeName));if("dataInputs"===a||"processOutputs"===a)c[a+"Description"]=b.parseDescribePuts($(this).children());else if("title"===a||"identifier"===a||"abstract"===a)c[a]=$(this).text()});d.push(c)}});return d};this.parseDescribePuts=function(a){var b,
d=this,g=[];a.each(function(){var a={};$.extend(a,M.Util.getAttributes($(this)));$(this).children().filter(function(){b=M.Util.lowerFirstLetter(M.Util.stripNS(this.nodeName));if("complexData"===b||"complexOutput"===b)a[b]=d.parseDescribeComplexPut($(this));else if("literalData"===b||"literalOutput"===b)a[b]=d.parseDescribeLiteralPut($(this));else if("boundingBoxData"===b||"boundingBoxOutput"===b)a[b]=d.parseDescribeBoundingBoxPut($(this));else if("title"===b||"identifier"===b||"abstract"===b)a[b]=
$(this).text()});g.push(a)});return g};this.parseDescribeComplexPut=function(a){var b,d=this,g={};$.extend(g,M.Util.getAttributes(a));a.children().filter(function(){b=M.Util.lowerFirstLetter(M.Util.stripNS(this.nodeName));"default"===b?g[b]=d.parseLeaf($(this).children()):"supported"===b&&(g[b]=[],$(this).children().filter(function(){g[b].push(d.parseLeaf($(this)))}))});return g};this.parseDescribeLiteralPut=function(a){var b,d={};$.extend(d,M.Util.getAttributes(a));a.children().filter(function(){b=
M.Util.lowerFirstLetter(M.Util.stripNS(this.nodeName));"dataType"===b&&$.extend(d,M.Util.getAttributes($(this)));"uOMs"===b?(d.UOMs={},$(this).children().filter(function(){b=M.Util.lowerFirstLetter(M.Util.stripNS(this.nodeName));"default"===b?d.UOMs["default"]=$(this).children().text():"supported"===b&&(d.UOMs.supported=[],$(this).children().filter(function(){d.UOMs.supported.push($(this).text())}))})):"allowedValues"===b?(d.allowedValues=[],$(this).children().filter(function(){b=M.Util.lowerFirstLetter(M.Util.stripNS(this.nodeName));
"value"===b&&d.allowedValues.push({value:$(this).text()})})):d[b]=$(this).text()});return d};this.parseDescribeBoundingBoxPut=function(a){var b,d={};a.children().filter(function(){b=M.Util.lowerFirstLetter(M.Util.stripNS(this.nodeName));"default"===b?d[b]=$(this).children().text():"supported"===b&&(d[b]=[],$(this).children().filter(function(){d[b].push($(this).text())}))});return d};this.parseLeaf=function(a,b){var d={};a.children().each(function(){d[b?M.Util.stripNS(this.nodeName):M.Util.lowerFirstLetter(M.Util.stripNS(this.nodeName))]=
$(this).text()});return d};this.execute=function(a,b){var d=this.getProcessDescriptor(a);return!d?!1:d.execute(b)};this.addProcessDescriptor=function(a){if(!a)return!1;$.extend(a,{wps:this});this.descriptors[a.identifier]=a;return!0};this.getProcessDescriptor=function(a){return!a?null:this.descriptors[a]};this.toHTML=function(){return!this.title?"":M.Util.parseTemplate(M.WPS.infoTemplate,{title:this.title,"abstract":this["abstract"],version:this.version,providerSite:this.serviceProvider.providerSite,
providerName:this.serviceProvider.providerName})};this.init(a);return this}};
M.WPS.ProcessDescriptor=function(a){this.title=this.identifier=this.wps=null;this.outputsProcessDescription=this.dataInputsDescription=this["abstract"]=null;this.inputs=[];this.outputs=[];this.init=function(a){$.extend(this,a)};this.clear=function(){this.clearInputs();this.clearOutputs()};this.clearInputs=function(){this.inputs=[]};this.clearOutputs=function(){this.outputs=[]};this.addInput=function(a){this.inputs.push(a)};this.addOutput=function(a){this.outputs.push(a)};this.getInputDescription=
function(a){if(this.dataInputsDescription&&this.dataInputsDescription.length)for(var c=0,e=this.dataInputsDescription.length;c<e;c++)if(this.dataInputsDescription[c].identifier===a)return this.dataInputsDescription[c];return null};this.execute=function(a){return(new M.WPS.Process({descriptor:this,inputs:M.Util.clone(this.inputs),outputs:M.Util.clone(this.outputs)})).execute(a)};this.init(a);return this};
M.WPS.Process=function(a){this.descriptor=null;this.inputs=[];this.outputs=[];this.result=this.status=this.statusLocation=this.statusAbstract=null;this.init=function(a){$.extend(this,a)};this.execute=function(a){var c,e,d,g,h,f,i="",j="",k=this,a=a||{};this.descriptor.storeSupported||(a.storeExecute=!1);if(!a.hasOwnProperty("storeExecute")){a.storeExecute=!1;c=0;for(e=this.outputs.length;c<e;c++)if("ComplexOutput"===this.outputs[c].type&&!M.Util.getGeoType(this.outputs[c].mimeType)){a.storeExecute=
!0;break}}d=M.Util.parseTemplate(M.WPS.executeRequestTemplate,{identifier:this.descriptor.identifier,storeExecute:a.storeExecute,status:a.storeExecute&&this.descriptor.statusSupported?!0:!1});c=0;for(e=this.inputs.length;c<e;c++)f=this.inputs[c],h=g="","LiteralData"===f.type&&f.data?g=M.Util.parseTemplate(M.WPS.literalDataInputTemplate,{identifier:f.identifier,data:f.data,uom:f.uom||""}):"ComplexData"===f.type&&(f.fileUrl?g=M.Util.parseTemplate(M.WPS.complexDataInputReferenceTemplate,{identifier:f.identifier,
reference:f.fileUrl.replace("&","&#038;")}):f.data&&(g=M.Util.parseTemplate(M.WPS.complexDataInputTemplate,{identifier:f.identifier,data:f.data})),f.format&&(f.format.mimeType&&(h+=' mimeType="'+f.format.mimeType+'"'),f.format.schema&&(h+=' schema="'+f.format.schema+'"'),f.format.encoding&&(h+=' encoding="'+f.format.encoding+'"')),g=g.replace("$format$",h)),j+=g;c=0;for(e=this.outputs.length;c<e;c++)f=this.outputs[c],h=g="","LiteralOutput"===f.type?g=M.Util.parseTemplate(M.WPS.literalOutputTemplate,
{identifier:f.identifier}):"ComplexOutput"===f.type?(a.hasOwnProperty("asReference")||(a.asReference=!0),f.mimeType&&(h+=' mimeType="'+f.mimeType+'"'),g=M.Util.parseTemplate(M.WPS.complexOutputTemplate,{identifier:f.identifier,asReference:M.Util.getGeoType(f.mimeType)?!1:a.asReference,format:h})):"BoundingBoxOutput"===f.type&&(g=M.Util.parseTemplate(M.WPS.boundingBoxOutputTemplate,{identifier:f.identifier})),i+=g;d=M.Util.parseTemplate(d,{dataInputs:j,dataOutputs:i});$.ajax({url:M.Util.proxify(M.Util.repareUrl(k.descriptor.wps.url),
"XML",k.descriptor.wps.proxyUrl),async:!0,type:"POST",dataType:"xml",contentType:"text/xml",data:d,success:function(a){k.result=k.parseExecuteResponse(a);k.result&&k.descriptor.wps.events.trigger("execute",k)},error:function(a){M.Util.message(a)}});return!0};this.parseExecuteResponse=function(a){var c,e=[],d=$(a),g=this;if("ExceptionReport"===M.Util.stripNS(d.children()[0].nodeName))return this.parseException(a),null;if(a=M.Util.getAttributes(d.children()).statusLocation)this.statusLocation=a;d.children().children().filter(function(){"Status"===
M.Util.stripNS(this.nodeName)?(g.status=M.Util.stripNS($(this).children()[0].nodeName),g.statusAbstract=$(this).children().first().text()):"ProcessOutputs"===M.Util.stripNS(this.nodeName)&&$(this).children().each(function(){var a={};$(this).children().each(function(){c=M.Util.lowerFirstLetter(M.Util.stripNS(this.nodeName));"identifier"===c?a[c]=$(this).text():"data"===c?(a.data={},$(this).children().filter(function(){c=M.Util.stripNS(this.nodeName);"LiteralData"===c?a.data.value=$(this).text():"ComplexData"===
c&&($.extend(a.data,M.Util.getAttributes($(this))),a.data.value="WMS"===M.Util.getGeoType(a.data.mimeType)?JSON.parse($.trim($(this).text())):"JSON"===M.Util.getGeoType(a.data.mimeType)?JSON.parse($.trim($(this).text())):$(this).children())})):"reference"===c&&(a.reference=M.Util.getAttributes($(this)))});e.push(a)})});return e};this.parseException=function(){M.Util.message("TODO - parse Exception")};this.init(a);return this};
M.WPS.asynchronousProcessManager=function(){this.items=[];this.init=function(){return this};this.get=function(a){if(!a)return null;for(var b=0,c=this.items.length;b<c;b++)if(this.items[b].statusLocation===a)return this.items[b];return null};this.add=function(a){if(!a)return!1;this.get(a.statusLocation)||(M.Util.message(a.descriptor.title+" : Process accepted and running...please wait for the result"),this.items.push({id:M.Util.sequence++,statusLocation:a.statusLocation,time:(new Date).toISOString(),
process:a}),this.update(a))};this.update=function(a){if(!a)return!1;this.get(a.statusLocation)&&"ProcessSucceeded"!==a.status&&setTimeout(function(){$.ajax({url:M.Util.proxify(a.statusLocation,"XML",a.descriptor.wps.proxyUrl),async:!0,type:"GET",dataType:"xml",contentType:"text/xml",success:function(b){a.result=a.parseExecuteResponse(b);M.Util.message("Process status : "+a.status);a.result&&a.descriptor.wps.events.trigger("execute",a)},error:function(a){M.Util.message(a)}})},3E3);this.updateProcessesList()};
this.remove=function(a){if(!a)return!1;for(var b=0,c=this.items.length;b<c;b++)if(this.items[b].statusLocation===a)return this.items.splice(b,1),this.updateProcessesList(),!0;return!1};this.updateProcessesList=function(){return!0};return this.init()};
M.WPS.Events=function(){this.events={getcapabilities:[],describeprocess:[],execute:[]};this.register=function(a,b,c){this.events[a]&&this.events[a].push({scope:b,handler:c})};this.unRegister=function(a){var b,c,e,d;for(e in this.events){b=this.events[e];c=0;for(d=b.length;c<d;c++)if(b[c].scope===a){b.splice(c,1);break}}};this.trigger=function(a,b){var c,e=this.events[a];if(e)for(c=e.length;c--;)e[c].handler(e[c].scope,b)};return this};M.WPS.infoTemplate='<div><h1>$title$</h1><p>$abstract$</p><p>Version $version$</p><h2>Provided by <a href="$providerSite$" target="_blank">$providerName$</a></h2></div>';
M.WPS.executeRequestTemplate='<?xml version="1.0" encoding="UTF-8" standalone="yes"?><wps:Execute service="WPS" version="1.0.0" xmlns:wps="http://www.opengis.net/wps/1.0.0" xmlns:ows="http://www.opengis.net/ows/1.1" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.opengis.net/wps/1.0.0/wpsExecute_request.xsd"><ows:Identifier>$identifier$</ows:Identifier><wps:DataInputs>$dataInputs$</wps:DataInputs><wps:ResponseForm><wps:ResponseDocument wps:lineage="false" storeExecuteResponse="$storeExecute$" status="$status$">$dataOutputs$</wps:ResponseDocument></wps:ResponseForm></wps:Execute>';
M.WPS.literalDataInputTemplate='<wps:Input><ows:Identifier>$identifier$</ows:Identifier><wps:Data><wps:LiteralData uom="$uom$">$data$</wps:LiteralData></wps:Data></wps:Input>';M.WPS.complexDataInputReferenceTemplate='<wps:Input><ows:Identifier>$identifier$</ows:Identifier><wps:Reference xlink:href="$reference$" $format$/></wps:Input>';M.WPS.complexDataInputTemplate="<wps:Input><ows:Identifier>$identifier$</ows:Identifier><wps:Data><wps:ComplexData $format$>$data$</wps:ComplexData></wps:Data></wps:Input>";
M.WPS.boundingBoxDataInputTemplate='<wps:Input><ows:Identifier>$identifier$</ows:Identifier><wps:Data><wps:BoundingBoxData ows:dimensions="$dimension$" ows:crs="$crs$"><ows:LowerCorner>$minx$ $miny$</ows:LowerCorner><ows:UpperCorner>$maxx$ $maxy$</ows:UpperCorner></wps:BoundingBoxData></wps:Data></wps:Input>';M.WPS.complexOutputTemplate='<wps:Output asReference="$asReference$" $format$><ows:Identifier>$identifier$</ows:Identifier></wps:Output>';M.WPS.literalOutputTemplate='<wps:Output asReference="false"><ows:Identifier>$identifier$</ows:Identifier></wps:Output>';
M.WPS.boundingBoxOutputTemplate=M.WPS.literalOutputTemplate;
